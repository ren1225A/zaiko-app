{% extends "base.html" %}

{% block content %}
<h2>ğŸ“‹ åœ¨åº«ä¸€è¦§</h2>

<!-- é€šçŸ¥ã‚¨ãƒªã‚¢ -->
{% if notifications %}
<div class="notifications">
    <h3>âš ï¸ åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ</h3>
    {% for notification in notifications %}
    <div class="notification-item">
        <p>
            <strong>{{ notification.item_name }}</strong> ã®åœ¨åº«ãŒå°‘ãªããªã£ã¦ã„ã¾ã™
            ï¼ˆç¾åœ¨: {{ notification.quantity_at_time }} / æœ€ä½åœ¨åº«æ•°: {{ notification.threshold_at_time }}ï¼‰
        </p>
        <small>{{ notification.triggered_at }}</small>
        <a href="{{ url_for('resolve_notification', notification_id=notification.notification_id) }}" 
           class="btn btn-small">è§£æ±º</a>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- åœ¨åº«ãƒªã‚¹ãƒˆï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ãƒ»ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ -->
{% if categories %}
    {% for category in categories %}
        {% if items_by_category[category.category_id]|length > 0 %}
        <div class="category-accordion">
            <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰ï¼‰ -->
            <div class="category-header" onclick="toggleCategory({{ category.category_id }})">
                <div class="category-header-left">
                    {% if category.icon_path %}
                    <img src="{{ url_for('static', filename='images/' + category.icon_path) }}" alt="{{ category.name }}" class="category-header-icon">
                    {% else %}
                    <span class="category-header-icon-placeholder">ğŸ“</span>
                    {% endif %}
                    <h3 class="category-header-title">{{ category.name }}</h3>
                    <span class="item-count">({{ items_by_category[category.category_id]|length }}å“ç›®)</span>
                </div>
                <span class="accordion-arrow" id="arrow-{{ category.category_id }}">â–¼</span>
            </div>
            
            <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ä¸­èº«ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->
            <div class="category-content" id="content-{{ category.category_id }}" style="display: none;">
                <div class="items-grid">
                    {% for item in items_by_category[category.category_id] %}
                    <div class="item-card {% if item.current_quantity < item.min_threshold %}low-stock{% endif %}">
                        <h3>{{ item.name }}</h3>
                        <div class="item-info">
                            <p class="quantity">
                                ç¾åœ¨: <strong>{{ item.current_quantity }} {{ item.unit }}</strong>
                            </p>
                            <p class="threshold">é–¾å€¤: {{ item.min_threshold }} {{ item.unit }}</p>
                            {% if item.supplier_name %}
                            <p class="supplier">ğŸ“ {{ item.supplier_name }}</p>
                            {% endif %}
                        </div>
                        
                        <!-- åœ¨åº«å¢—æ¸›ãƒ•ã‚©ãƒ¼ãƒ  -->
                        <form method="POST" action="{{ url_for('update_stock', item_id=item.item_id) }}" class="stock-form">
                            <!-- ã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³ -->
                            <div class="quick-buttons">
                                <button type="button" class="quick-btn decrease" data-value="-50">-50</button>
                                <button type="button" class="quick-btn decrease" data-value="-10">-10</button>
                                <button type="button" class="quick-btn decrease" data-value="-5">-5</button>
                                <button type="button" class="quick-btn decrease" data-value="-1">-1</button>
                                <button type="button" class="quick-btn decrease" data-value="-0.1">-0.1</button>
                                <button type="button" class="quick-btn increase" data-value="0.1">+0.1</button>
                                <button type="button" class="quick-btn increase" data-value="1">+1</button>
                                <button type="button" class="quick-btn increase" data-value="5">+5</button>
                                <button type="button" class="quick-btn increase" data-value="10">+10</button>
                                <button type="button" class="quick-btn increase" data-value="50">+50</button>
                            </div>
                            
                            <!-- ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
                            <div class="reset-row">
                                <button type="button" class="btn-reset">ãƒªã‚»ãƒƒãƒˆ</button>
                            </div>
                            
                            <div class="form-row">
                                <input type="number" name="quantity_delta" step="0.1" placeholder="Â±æ•°é‡" required readonly>
                                <span>{{ item.unit }}</span>
                            </div>
                            
                            <select name="reason" required>
                                <option value="">ç†ç”±ã‚’é¸æŠ</option>
                                <option value="å…¥è·">å…¥è·</option>
                                <option value="ä½¿ç”¨">ä½¿ç”¨</option>
                                <option value="å»ƒæ£„">å»ƒæ£„</option>
                                <option value="æ£šå¸ã—">æ£šå¸ã—</option>
                            </select>
                            
                            <input type="text" name="note" placeholder="ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰">
                            
                            <button type="submit" class="btn btn-primary">æ›´æ–°</button>
                        </form>
                        
                        <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼å¤‰æ›´ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆåº—ä¸»ã®ã¿ï¼‰ -->
                        {% if session.get('role') == 'owner' %}
                        <div class="owner-actions">
                            <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼å¤‰æ›´ -->
                            <form method="POST" action="{{ url_for('change_category', item_id=item.item_id) }}" class="category-change-form">
                                <select name="category_id" onchange="this.form.submit()">
                                    <option value="">ã‚«ãƒ†ã‚´ãƒªãƒ¼ç§»å‹•</option>
                                    {% for cat in categories %}
                                        {% if cat.category_id != category.category_id %}
                                        <option value="{{ cat.category_id }}">â†’ {{ cat.name }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </form>
                            
                            <!-- å‰Šé™¤ -->
                            <form method="POST" action="{{ url_for('delete_item', item_id=item.item_id) }}" class="delete-form" onsubmit="return confirm('æœ¬å½“ã«ã€Œ{{ item.name }}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ');">
                                <button type="submit" class="btn btn-danger">å‰Šé™¤</button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    {% endfor %}
{% else %}
    <p class="empty-message">ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
{% endif %}

{% if not categories or (categories|length == 0) %}
<p class="empty-message">ã¾ã å“ç›®ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
{% if session.get('role') == 'owner' %}
<a href="{{ url_for('add_item') }}" class="btn btn-primary">æœ€åˆã®å“ç›®ã‚’è¿½åŠ </a>
{% endif %}
{% endif %}

{% endblock %}