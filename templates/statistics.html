{% extends "base.html" %}

{% block content %}
<h2>ğŸ“Š çµ±è¨ˆãƒ»ãƒ¬ãƒãƒ¼ãƒˆ</h2>

<!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
<div class="stats-summary">
    <div class="summary-card">
        <h3>ä»Šæœˆã®å…¥è·å“ç›®</h3>
        <p class="summary-number">{{ monthly_summary.items_received or 0 }}</p>
        <p class="summary-label">å“ç›®</p>
    </div>
    
    <div class="summary-card">
        <h3>ä»Šæœˆã®ä½¿ç”¨å“ç›®</h3>
        <p class="summary-number">{{ monthly_summary.items_used or 0 }}</p>
        <p class="summary-label">å“ç›®</p>
    </div>
    
    <div class="summary-card">
        <h3>åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ</h3>
        <p class="summary-number alert">{{ low_stock_items|length }}</p>
        <p class="summary-label">å“ç›®</p>
    </div>
</div>

<!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
<div class="charts-container">
    
    <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥åœ¨åº«å‰²åˆ -->
    <div class="chart-box">
        <h3>ğŸ“ ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥å“ç›®æ•°</h3>
        <canvas id="categoryChart"></canvas>
    </div>
    
    <!-- ã‚ˆãä½¿ã†å“ç›®ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
    <div class="chart-box wide">
        <h3>ğŸ† ä»Šæœˆã‚ˆãä½¿ã†å“ç›®ãƒˆãƒƒãƒ—10</h3>
        <canvas id="topItemsChart"></canvas>
    </div>
    <!-- å˜ä½ã”ã¨ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
    {% for unit, items in units_ranking.items() %}
    <div class="chart-box">
        <h3>ğŸ“Š {{ unit }}ã®ä½¿ç”¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
        <canvas id="unitChart_{{ unit|replace('.', '_')|replace(' ', '_') }}"></canvas>
    </div>
    {% endfor %}


<!-- åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆä¸€è¦§ -->
{% if low_stock_items %}
<div class="alert-section">
    <h3>âš ï¸ åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆé–¾å€¤120%ä»¥ä¸‹ï¼‰</h3>
    <div class="alert-table">
        <table>
            <thead>
                <tr>
                    <th>å“ç›®å</th>
                    <th>ç¾åœ¨åœ¨åº«</th>
                    <th>é–¾å€¤</th>
                    <th>å‰²åˆ</th>
                    <th>çŠ¶æ…‹</th>
                </tr>
            </thead>
            <tbody>
                {% for item in low_stock_items %}
                <tr class="{% if item.percentage < 50 %}critical{% elif item.percentage < 80 %}warning{% endif %}">
                    <td><strong>{{ item.item_name }}</strong></td>
                    <td>{{ item.current_quantity }} {{ item.unit }}</td>
                    <td>{{ item.min_threshold }} {{ item.unit }}</td>
                    <td>{{ item.percentage }}%</td>
                    <td>
                        {% if item.percentage < 50 %}
                        <span class="badge badge-critical">ğŸ”´ ç·Šæ€¥</span>
                        {% elif item.percentage < 80 %}
                        <span class="badge badge-warning">ğŸŸ¡ æ³¨æ„</span>
                        {% else %}
                        <span class="badge badge-caution">ğŸŸ  ã‚„ã‚„å°‘</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- ã‚ˆãä½¿ã†å“ç›®ã®è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
{% if top_items %}
<div class="top-items-section">
    <h3>ğŸ“‹ ä»Šæœˆã®ä½¿ç”¨é‡è©³ç´°</h3>
    <div class="usage-details-grid">
        {% for item in top_items %}
        <div class="usage-card {% if loop.index <= 3 %}top-rank{% endif %}">
            <div class="usage-card-header">
                <span class="usage-rank">
                    {% if loop.index == 1 %}ğŸ¥‡
                    {% elif loop.index == 2 %}ğŸ¥ˆ
                    {% elif loop.index == 3 %}ğŸ¥‰
                    {% else %}{{ loop.index }}ä½
                    {% endif %}
                </span>
                <h4>{{ item.item_name }}</h4>
            </div>
            <div class="usage-card-body">
                <div class="usage-stat">
                    <span class="usage-label">ä½¿ç”¨é‡</span>
                    <span class="usage-value">{{ "%.1f"|format(item.total_usage) }} <span class="unit">{{ item.unit }}</span></span>
                </div>
                <div class="usage-stat">
                    <span class="usage-label">ä½¿ç”¨å›æ•°</span>
                    <span class="usage-value">{{ item.transaction_count }} <span class="unit">å›</span></span>
                </div>
                <div class="usage-stat">
                    <span class="usage-label">1å›ã‚ãŸã‚Š</span>
                    <span class="usage-value">{{ "%.1f"|format(item.total_usage / item.transaction_count) }} <span class="unit">{{ item.unit }}</span></span>
                </div>
            </div>
            <div class="usage-progress">
                <div class="usage-bar" style="width: {{ (item.total_usage / top_items[0].total_usage * 100) if top_items else 0 }}%"></div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
<a href="{{ url_for('index') }}" class="btn btn-secondary">åœ¨åº«ä¸€è¦§ã«æˆ»ã‚‹</a>

<!-- Chart.js ã‚’èª­ã¿è¾¼ã¿ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ã‚°ãƒ©ãƒ•æç”»ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script>
// ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥å††ã‚°ãƒ©ãƒ•
const categoryData = {
    labels: [
        {% for cat in category_stock %}
        '{{ cat.category_name }}'{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    datasets: [{
        data: [
            {% for cat in category_stock %}
            {{ cat.item_count }}{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        backgroundColor: [
            '#667eea',
            '#764ba2',
            '#f093fb',
            '#4facfe',
            '#43e97b',
            '#fa709a',
            '#fee140'
        ]
    }]
};

new Chart(document.getElementById('categoryChart'), {
    type: 'doughnut',
    data: categoryData,
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    font: { size: 14 },
                    padding: 15
                }
            }
        }
    }
});

// ã‚ˆãä½¿ã†å“ç›®ã®æ£’ã‚°ãƒ©ãƒ•
const topItemsData = {
    labels: [
        {% for item in top_items %}
        '{{ item.item_name }}'{% if not loop.last %},{% endif %}
        {% endfor %}
    ],
    datasets: [{
        label: 'ä½¿ç”¨é‡',
        data: [
            {% for item in top_items %}
            {{ item.total_usage }}{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        backgroundColor: 'rgba(102, 126, 234, 0.8)',
        borderColor: 'rgba(102, 126, 234, 1)',
        borderWidth: 2
    }]
};

new Chart(document.getElementById('topItemsChart'), {
    type: 'bar',
    data: topItemsData,
    options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { font: { size: 12 } }
            },
            x: {
                ticks: { font: { size: 12 } }
            }
        }
    }
});
// å˜ä½ã”ã¨ã®ã‚°ãƒ©ãƒ•
{% for unit, items in units_ranking.items() %}
new Chart(document.getElementById('unitChart_{{ unit|replace(".", "_")|replace(" ", "_") }}'), {
    type: 'bar',
    data: {
        labels: [
            {% for item in items %}
            '{{ item.item_name }}'{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            label: 'ä½¿ç”¨é‡ ({{ unit }})',
            data: [
                {% for item in items %}
                {{ item.total_usage }}{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            backgroundColor: 'rgba(118, 75, 162, 0.8)',
            borderColor: 'rgba(118, 75, 162, 1)',
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: true }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: { font: { size: 12 } }
            },
            x: {
                ticks: { font: { size: 11 } }
            }
        }
    }
});
{% endfor %}

</script>

{% endblock %}